<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ร้านพอใจสระด่วน - ระบบลงเวลา</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; font-family: 'Prompt', sans-serif; -webkit-tap-highlight-color: transparent; }
    .gradient-bg { background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 50%, #e0f7fa 100%); }
    .card-shadow { box-shadow: 0 10px 40px rgba(0, 150, 200, 0.1), 0 4px 12px rgba(0, 0, 0, 0.05); }
    .btn-press { transition: all 0.15s ease; }
    .btn-press:active { transform: scale(0.96); }
    .toast { animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards; }
    @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    .photo-preview { animation: scaleIn 0.3s ease; }
    @keyframes scaleIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .pulse-ring { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
  </style>
 </head>
 <body class="h-full">
  <div id="app" class="h-full gradient-bg overflow-auto">
   <div class="min-h-full p-4 pb-8">
    <div class="text-center mb-6 pt-4">
     <div class="inline-flex items-center justify-center w-16 h-16 rounded-full mb-3" style="background: linear-gradient(135deg, #0ea5e9, #06b6d4);">
      <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
     </div>
     <h1 class="text-2xl font-bold text-gray-800">ร้านพอใจสระด่วน</h1>
     <p class="text-gray-500 text-sm mt-1">ระบบลงเวลาพนักงาน</p>
    </div>
    
    <div class="bg-white rounded-2xl p-4 mb-4 card-shadow mx-auto max-w-md">
     <div class="text-center">
       <p id="current-date" class="text-lg font-semibold text-gray-700"></p>
       <p id="current-time" class="text-3xl font-bold text-sky-600"></p>
     </div>
    </div>

    <div class="bg-white rounded-3xl p-6 card-shadow mx-auto max-w-md">
     <div class="mb-5">
       <label class="block text-gray-600 text-sm font-medium mb-2"> 
         <span class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg> ชื่อเล่นพนักงาน 
         </span> 
       </label> 
       <input type="text" id="employee-name" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-sky-400 focus:outline-none transition-colors text-lg" placeholder="กรอกชื่อเล่น...">
     </div>

     <div class="mb-5">
       <label class="block text-gray-600 text-sm font-medium mb-2"> 
         <span class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg> ถ่ายรูปยืนยันตัวตน <span class="text-red-500">*</span> 
         </span> 
       </label>
       <div id="photo-container" class="relative">
         <div id="photo-preview-wrapper" class="hidden">
           <img id="photo-preview" class="w-full h-48 object-cover rounded-xl photo-preview"> 
           <button id="retake-btn" class="absolute top-2 right-2 bg-white/90 text-gray-700 p-2 rounded-full shadow-lg btn-press">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
           </button>
         </div>
         <button id="camera-btn" class="w-full h-48 border-3 border-dashed border-sky-300 rounded-xl flex flex-col items-center justify-center gap-3 bg-sky-50/50 hover:bg-sky-100/50 transition-colors btn-press pulse-ring">
          <div class="w-16 h-16 rounded-full bg-sky-500 flex items-center justify-center">
           <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
          </div>
          <span class="text-sky-600 font-medium">แตะเพื่อถ่ายรูป</span>
         </button>
       </div>
       <input type="file" id="camera-input" accept="image/*" capture="user" class="hidden">
     </div>

     <div class="grid grid-cols-2 gap-4">
       <button id="checkin-btn" class="py-4 px-4 rounded-2xl font-semibold text-white text-lg flex flex-col items-center gap-2 btn-press" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
         <svg class="w-8 h-8" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" /></svg>
         <span>เข้างาน</span> 
       </button> 
       <button id="checkout-btn" class="py-4 px-4 rounded-2xl font-semibold text-white text-lg flex flex-col items-center gap-2 btn-press" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
         <svg class="w-8 h-8" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
         <span>ออกงาน</span> 
       </button>
     </div>
     
     <p id="warning-msg" class="text-center text-amber-600 text-sm mt-4 flex items-center justify-center gap-1">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg> 
      กรุณาถ่ายรูปก่อนลงเวลา
     </p>
    </div>

    <div id="records-section" class="mt-6 mx-auto max-w-md hidden">
     <h3 class="text-gray-600 font-medium mb-3 flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg> 
      บันทึกล่าสุด
     </h3>
     <div id="records-list" class="space-y-2"></div>
    </div>
   </div>

   <div id="toast-container" class="fixed top-4 left-4 right-4 z-50 flex flex-col items-center gap-2"></div>
   <div id="loading-overlay" class="fixed inset-0 bg-black/30 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-6 flex flex-col items-center gap-3">
     <div class="w-10 h-10 border-4 border-sky-200 border-t-sky-500 rounded-full animate-spin"></div>
     <p class="text-gray-600 font-medium">กำลังบันทึกข้อมูล...</p>
    </div>
   </div>
  </div>
  
  <script>
    // ============================================
    // ส่วนตั้งค่าระบบ (กรุณาแก้ไขตรงนี้)
    // ============================================
    
    // ใส่ URL ของ Google Apps Script ที่ได้จากการ Deploy ตรงนี้
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbykYjpj_cZjIvbfEX-id_HgXBwDfd3yeSe3Q5qKubcWBnO3UnBUvOTXlvem2ogXGYAMDg/exec'; 
    
    // ============================================

    let currentPhotoData = null;
    let records = [];
    let isProcessing = false;

    // ระบบเวลา
    function updateDateTime() {
      const now = new Date();
      document.getElementById('current-date').textContent = now.toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('current-time').textContent = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
    }

    // ระบบแจ้งเตือน (Toast)
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-amber-500';
      toast.className = `toast ${bgColor} text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-2 max-w-sm`;
      toast.innerHTML = `<span class="font-medium">${message}</span>`;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // ระบบ Loading
    function setLoading(show) {
      document.getElementById('loading-overlay').classList.toggle('hidden', !show);
      isProcessing = show;
    }

    // ระบบกล้อง
    function setupCamera() {
      const cameraBtn = document.getElementById('camera-btn');
      const cameraInput = document.getElementById('camera-input');
      const retakeBtn = document.getElementById('retake-btn');
      const photoPreview = document.getElementById('photo-preview');
      const photoPreviewWrapper = document.getElementById('photo-preview-wrapper');
      const warningMsg = document.getElementById('warning-msg');

      cameraBtn.addEventListener('click', () => cameraInput.click());
      retakeBtn.addEventListener('click', () => cameraInput.click());

      cameraInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            currentPhotoData = event.target.result;
            photoPreview.src = currentPhotoData;
            photoPreviewWrapper.classList.remove('hidden');
            cameraBtn.classList.add('hidden');
            warningMsg.classList.add('hidden');
          };
          reader.readAsDataURL(file);
        }
      });
    }

    function resetPhoto() {
      currentPhotoData = null;
      document.getElementById('photo-preview-wrapper').classList.add('hidden');
      document.getElementById('camera-btn').classList.remove('hidden');
      document.getElementById('warning-msg').classList.remove('hidden');
      document.getElementById('camera-input').value = '';
    }

    // ฟังก์ชันบันทึกเวลา (ฉบับ Google Drive - ไม่ใช้ Imgur แล้ว)
    async function recordTime(actionType) {
      if (isProcessing) return;
      
      const employeeName = document.getElementById('employee-name').value.trim();
      if (!employeeName) { showToast('กรุณากรอกชื่อพนักงาน', 'warning'); return; }
      if (!currentPhotoData) { showToast('กรุณาถ่ายรูปก่อนลงเวลา', 'warning'); return; }

      // เช็คว่าใส่ URL หรือยัง
      if (APPS_SCRIPT_URL.includes('xxxx') || APPS_SCRIPT_URL === '') {
        showToast('กรุณาใส่ Apps Script URL ในโค้ดก่อน', 'error');
        return;
      }

      setLoading(true);

      try {
        const now = new Date();
        const dateDisplay = now.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const timeDisplay = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', hour12: false });
        
        // เตรียมข้อมูลส่งให้ Google Script (ส่ง Base64 ไปตรงๆ)
        const payload = {
          employee_name: employeeName,
          action_type: actionType,
          photo_base64: currentPhotoData, // <-- ส่งรูปตัวเต็ม
          date_display: dateDisplay,
          time_display: timeDisplay
        };

        showToast('กำลังบันทึกข้อมูลและอัปโหลดรูป...', 'warning');
        
        // ส่งข้อมูล (ใช้ mode: no-cors เพื่อให้ส่งผ่าน)
        await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors', 
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        // สำเร็จ
        showToast(`${actionType}สำเร็จ - ${employeeName}`, 'success');
        resetPhoto();

        // บันทึกลง LocalStorage (เพื่อโชว์หน้าเว็บ แต่จะไม่มีลิ้งก์รูปทันทีเพราะต้องรอ Google สร้าง)
        const recordForDisplay = { ...payload, photo_data: '' }; 
        records.push(recordForDisplay);
        localStorage.setItem('attendance_records', JSON.stringify(records));
        renderRecords();

      } catch (error) {
        console.error(error);
        showToast('เกิดข้อผิดพลาด! กรุณาลองใหม่', 'error');
      } finally {
        setLoading(false);
      }
    }

    // แสดงประวัติล่าสุด
    function renderRecords() {
      const recordsSection = document.getElementById('records-section');
      const recordsList = document.getElementById('records-list');
      
      if (records.length === 0) {
        recordsSection.classList.add('hidden');
        return;
      }

      recordsSection.classList.remove('hidden');
      const recentRecords = records.slice().reverse().slice(0, 5); 
      
      recordsList.innerHTML = recentRecords.map(record => {
        const isCheckin = record.action_type === 'เข้างาน';
        const bgColor = isCheckin ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
        const icon = isCheckin 
          ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14"/>'
          : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7"/>';
        
        // ถ้ามีรูป (ซึ่ง local จะไม่มี) ให้โชว์ลิ้งก์
        const photoHtml = record.photo_data && record.photo_data.startsWith('http')
          ? `<a href="${record.photo_data}" target="_blank" class="text-xs text-sky-500 hover:underline block mt-1">ดูรูปถ่าย</a>` 
          : `<span class="text-xs text-gray-400 block mt-1">บันทึกเรียบร้อย</span>`;

        return `
          <div class="flex items-center gap-3 p-3 ${bgColor} border rounded-xl">
            <div class="w-10 h-10 rounded-full ${isCheckin ? 'bg-green-500' : 'bg-red-500'} flex items-center justify-center">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">${icon}</svg>
            </div>
            <div class="flex-1">
              <p class="font-medium text-gray-800">${record.employee_name}</p>
              <p class="text-sm text-gray-500">${record.date_display} - ${record.time_display}</p>
              ${photoHtml}
            </div>
            <span class="px-3 py-1 rounded-full text-sm font-medium ${isCheckin ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100'}">
              ${record.action_type}
            </span>
          </div>
        `;
      }).join('');
    }

    function init() {
      updateDateTime();
      setInterval(updateDateTime, 1000);
      setupCamera();
      
      const saved = localStorage.getItem('attendance_records');
      if (saved) {
        records = JSON.parse(saved);
        renderRecords();
      }

      document.getElementById('checkin-btn').addEventListener('click', () => recordTime('เข้างาน'));
      document.getElementById('checkout-btn').addEventListener('click', () => recordTime('ออกงาน'));
    }

    init();
  </script>
 </body>
</html>